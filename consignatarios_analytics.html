<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shipper Per√∫ ‚Äî An√°lisis de Consignatarios</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e17;
  --surface: #111827;
  --surface-2: #1a2236;
  --surface-3: #1f2b42;
  --border: #2a3654;
  --text: #e8ecf4;
  --text-muted: #7b8ba5;
  --accent: #f97316;
  --accent-glow: rgba(249, 115, 22, 0.15);
  --accent-2: #fb923c;
  --green: #22c55e;
  --green-bg: rgba(34, 197, 94, 0.1);
  --red: #ef4444;
  --red-bg: rgba(239, 68, 68, 0.1);
  --blue: #3b82f6;
  --blue-bg: rgba(59, 130, 246, 0.1);
  --purple: #a855f7;
  --purple-bg: rgba(168, 85, 247, 0.1);
  --yellow: #eab308;
  --yellow-bg: rgba(234, 179, 8, 0.1);
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Background grain */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* Header */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(10, 14, 23, 0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--accent), #ea580c);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
  color: white;
  box-shadow: 0 0 20px var(--accent-glow);
}

.logo-text {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.logo-text span { color: var(--accent); }

.header-badge {
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
  background: var(--surface-2);
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
}

/* Main layout */
.app { position: relative; z-index: 1; }

.container {
  max-width: 1360px;
  margin: 0 auto;
  padding: 24px 32px;
}

/* Upload zone */
.upload-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 60px 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: var(--surface);
  position: relative;
  overflow: hidden;
}

.upload-zone::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 50% 50%, var(--accent-glow), transparent 70%);
  opacity: 0;
  transition: opacity 0.3s;
}

.upload-zone:hover, .upload-zone.dragover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow), 0 0 40px var(--accent-glow);
}

.upload-zone:hover::before, .upload-zone.dragover::before { opacity: 1; }

.upload-icon {
  font-size: 48px;
  margin-bottom: 16px;
  position: relative;
  z-index: 1;
}

.upload-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
  position: relative;
  z-index: 1;
}

.upload-sub {
  color: var(--text-muted);
  font-size: 14px;
  position: relative;
  z-index: 1;
}

.upload-sub span {
  color: var(--accent);
  text-decoration: underline;
  font-weight: 500;
}

#fileInput { display: none; }

/* File loaded bar */
.file-bar {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 24px;
  margin-bottom: 24px;
  align-items: center;
  gap: 16px;
  animation: slideIn 0.4s ease;
}

.file-bar.visible { display: flex; }

.file-bar-icon {
  width: 44px;
  height: 44px;
  background: var(--green-bg);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.file-bar-info { flex: 1; }
.file-bar-name { font-weight: 600; font-size: 14px; }
.file-bar-meta { color: var(--text-muted); font-size: 12px; margin-top: 2px; font-family: 'Space Mono', monospace; }

.file-bar-btn {
  padding: 8px 20px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.2s;
}

.file-bar-btn:hover { background: var(--surface-3); border-color: var(--accent); }

/* Dashboard content (hidden until data loaded) */
.dashboard { display: none; }
.dashboard.visible { display: block; animation: fadeIn 0.5s ease; }

/* KPI Cards */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.kpi-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  position: relative;
  overflow: hidden;
  transition: all 0.25s;
}

.kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

.kpi-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.kpi-card:nth-child(1)::after { background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
.kpi-card:nth-child(2)::after { background: linear-gradient(90deg, var(--blue), #60a5fa); }
.kpi-card:nth-child(3)::after { background: linear-gradient(90deg, var(--green), #4ade80); }
.kpi-card:nth-child(4)::after { background: linear-gradient(90deg, var(--purple), #c084fc); }
.kpi-card:nth-child(5)::after { background: linear-gradient(90deg, var(--yellow), #facc15); }

.kpi-label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 32px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  letter-spacing: -1px;
}

.kpi-sub {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Filters bar */
.filters-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  align-items: center;
}

.search-box {
  flex: 1;
  min-width: 260px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 12px 16px 12px 44px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  transition: border-color 0.2s;
  outline: none;
}

.search-box input:focus { border-color: var(--accent); }

.search-box input::placeholder { color: var(--text-muted); }

.search-box::before {
  content: 'üîç';
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  pointer-events: none;
}

.filter-select {
  padding: 12px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  outline: none;
  min-width: 160px;
  transition: border-color 0.2s;
}

.filter-select:focus { border-color: var(--accent); }

/* Tabs */
.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
  background: var(--surface);
  border-radius: var(--radius);
  padding: 4px;
  border: 1px solid var(--border);
  overflow-x: auto;
}

.tab {
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  color: var(--text-muted);
  background: transparent;
  border: none;
  font-family: 'DM Sans', sans-serif;
}

.tab:hover { color: var(--text); background: var(--surface-2); }

.tab.active {
  background: var(--accent);
  color: white;
  box-shadow: 0 2px 8px var(--accent-glow);
}

/* Tab panels */
.tab-panel { display: none; }
.tab-panel.active { display: block; animation: fadeIn 0.3s ease; }

/* Table */
.table-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.table-header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}

.table-title {
  font-weight: 600;
  font-size: 15px;
}

.table-count {
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  color: var(--text-muted);
}

.btn-download {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  font-family: 'DM Sans', sans-serif;
  transition: all 0.2s;
}

.btn-download:hover { background: var(--accent); border-color: var(--accent); color: white; }

table {
  width: 100%;
  border-collapse: collapse;
}

thead th {
  padding: 12px 20px;
  text-align: left;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-muted);
  font-weight: 600;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
  transition: color 0.2s;
  white-space: nowrap;
}

thead th:hover { color: var(--accent); }
thead th.sorted { color: var(--accent); }

thead th .sort-arrow {
  display: inline-block;
  margin-left: 4px;
  font-size: 10px;
  opacity: 0.5;
}

thead th.sorted .sort-arrow { opacity: 1; }

tbody tr {
  border-bottom: 1px solid rgba(42, 54, 84, 0.4);
  transition: background 0.15s;
}

tbody tr:hover { background: var(--surface-2); }
tbody tr:last-child { border-bottom: none; }

tbody td {
  padding: 12px 20px;
  font-size: 14px;
}

.td-rank {
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  color: var(--text-muted);
  width: 50px;
}

.td-name { font-weight: 500; }

.td-count {
  font-family: 'Space Mono', monospace;
  font-weight: 700;
}

.count-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 13px;
}

.count-high { background: var(--accent-glow); color: var(--accent-2); }
.count-mid { background: var(--blue-bg); color: var(--blue); }
.count-low { background: var(--surface-3); color: var(--text-muted); }

/* Pagination */
.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  border-top: 1px solid var(--border);
}

.pagination-info {
  font-size: 12px;
  color: var(--text-muted);
  font-family: 'Space Mono', monospace;
}

.pagination-btns {
  display: flex;
  gap: 4px;
}

.pg-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-muted);
  cursor: pointer;
  font-size: 13px;
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  transition: all 0.2s;
}

.pg-btn:hover:not(.disabled) { border-color: var(--accent); color: var(--accent); }
.pg-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
.pg-btn.disabled { opacity: 0.3; cursor: not-allowed; }

/* Charts section */
.chart-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 24px;
}

.chart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
}

.chart-card-title {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.chart-card-title span {
  font-size: 16px;
}

/* Bar chart */
.bar-chart { display: flex; flex-direction: column; gap: 8px; }

.bar-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.bar-label {
  width: 180px;
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 0;
  text-align: right;
}

.bar-track {
  flex: 1;
  height: 28px;
  background: var(--surface-2);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}

.bar-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
}

.bar-fill-top { background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
.bar-fill-bottom { background: linear-gradient(90deg, var(--blue), #60a5fa); }

.bar-value {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  color: white;
}

.bar-value-outside {
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-muted);
  min-width: 30px;
}

/* Monthly chart */
.monthly-bars {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  height: 200px;
  padding-top: 20px;
}

.month-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  justify-content: flex-end;
  gap: 6px;
}

.month-bar-wrap {
  width: 100%;
  display: flex;
  justify-content: center;
  flex: 1;
  align-items: flex-end;
}

.month-bar {
  width: 80%;
  max-width: 50px;
  border-radius: 6px 6px 2px 2px;
  background: linear-gradient(180deg, var(--accent), #ea580c);
  transition: height 1s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
  cursor: pointer;
}

.month-bar:hover { filter: brightness(1.2); }

.month-bar-val {
  position: absolute;
  top: -22px;
  left: 50%;
  transform: translateX(-50%);
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  color: var(--accent-2);
}

.month-label {
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
}

/* Frequency distribution */
.freq-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 8px;
}

.freq-cell {
  text-align: center;
  padding: 12px 8px;
  background: var(--surface-2);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  transition: all 0.2s;
}

.freq-cell:hover { border-color: var(--accent); transform: translateY(-1px); }

.freq-num {
  font-family: 'Space Mono', monospace;
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
}

.freq-label {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 2px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* Animations */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* Responsive */
@media (max-width: 900px) {
  .chart-grid { grid-template-columns: 1fr; }
  .container { padding: 16px; }
  .header { padding: 12px 16px; }
  .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
  .bar-label { width: 120px; font-size: 11px; }
  .kpi-value { font-size: 24px; }
}

@media (max-width: 600px) {
  .filters-bar { flex-direction: column; }
  .search-box { min-width: 100%; }
  .filter-select { width: 100%; }
  .tabs { overflow-x: auto; }
}

/* Small detail: pulse on accent */
.pulse { animation: pulse 2s ease-in-out infinite; }
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
</style>
</head>
<body>

<header class="header">
  <div class="logo">
    <div class="logo-icon">S</div>
    <div class="logo-text">Shipper<span>Per√∫</span> ‚Äî Consignatarios</div>
  </div>
  <div class="header-badge" id="headerBadge">SIN DATOS</div>
</header>

<div class="app">
  <div class="container">

    <!-- Upload zone -->
    <div class="upload-zone" id="uploadZone">
      <div class="upload-icon">üì¶</div>
      <div class="upload-title">Arrastra tu archivo CSV de TRAMA aqu√≠</div>
      <div class="upload-sub">o <span>haz clic para seleccionar</span> ‚Äî Formato: TRAMA DD/MM/AAAA</div>
    </div>
    <input type="file" id="fileInput" accept=".csv,.txt">

    <!-- File bar -->
    <div class="file-bar" id="fileBar">
      <div class="file-bar-icon">‚úÖ</div>
      <div class="file-bar-info">
        <div class="file-bar-name" id="fileName">‚Äî</div>
        <div class="file-bar-meta" id="fileMeta">‚Äî</div>
      </div>
      <button class="file-bar-btn" onclick="resetApp()">Cargar otro archivo</button>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">

      <!-- KPIs -->
      <div class="kpi-grid" id="kpiGrid">
        <div class="kpi-card">
          <div class="kpi-label">Total Registros</div>
          <div class="kpi-value" id="kpiTotal">0</div>
          <div class="kpi-sub">entradas procesadas</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Consignatarios √önicos</div>
          <div class="kpi-value" id="kpiUnique">0</div>
          <div class="kpi-sub">nombres distintos</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Recurrentes</div>
          <div class="kpi-value" id="kpiRecurrent">0</div>
          <div class="kpi-sub">aparecen m√°s de 1 vez</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Promedio usos</div>
          <div class="kpi-value" id="kpiAvg">0</div>
          <div class="kpi-sub">veces por consignatario</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Tramas cargadas</div>
          <div class="kpi-value" id="kpiTramas">0</div>
          <div class="kpi-sub" id="kpiTramaRange">‚Äî</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-bar">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Buscar consignatario por nombre...">
        </div>
        <select class="filter-select" id="monthFilter">
          <option value="all">Todos los meses</option>
        </select>
        <select class="filter-select" id="minFilter">
          <option value="0">Todos los usos</option>
          <option value="1">1 uso (√∫nicos)</option>
          <option value="2">2+ usos</option>
          <option value="5">5+ usos</option>
          <option value="10">10+ usos</option>
        </select>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="tabla">üìã Tabla Completa</button>
        <button class="tab" data-tab="top10">üèÜ Top 10 M√°s</button>
        <button class="tab" data-tab="bottom10">üìâ Top 10 Menos</button>
        <button class="tab" data-tab="low5">‚ö†Ô∏è 5 usos o menos</button>
        <button class="tab" data-tab="charts">üìä Gr√°ficos</button>
      </div>

      <!-- Tab: Tabla completa -->
      <div class="tab-panel active" id="panel-tabla">
        <div class="table-wrap">
          <div class="table-header-bar">
            <div>
              <span class="table-title">Todos los consignatarios</span>
              <span class="table-count" id="tableCount"></span>
            </div>
            <button class="btn-download" onclick="downloadCSV('full')">‚¨á Descargar CSV</button>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th class="sorted" data-sort="rank"># <span class="sort-arrow">‚ñ≤</span></th>
                  <th data-sort="name">Nombre <span class="sort-arrow">‚áÖ</span></th>
                  <th data-sort="count">Cantidad <span class="sort-arrow">‚áÖ</span></th>
                  <th data-sort="first">Primera vez <span class="sort-arrow">‚áÖ</span></th>
                  <th data-sort="last">√öltima vez <span class="sort-arrow">‚áÖ</span></th>
                </tr>
              </thead>
              <tbody id="mainTableBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="mainPagination"></div>
        </div>
      </div>

      <!-- Tab: Top 10 m√°s -->
      <div class="tab-panel" id="panel-top10">
        <div class="table-wrap">
          <div class="table-header-bar">
            <span class="table-title">üèÜ Top 10 ‚Äî M√°s frecuentes</span>
            <button class="btn-download" onclick="downloadCSV('top10')">‚¨á Descargar CSV</button>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead><tr><th>#</th><th>Nombre</th><th>Cantidad</th><th>Primera vez</th><th>√öltima vez</th></tr></thead>
              <tbody id="top10Body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab: Top 10 menos -->
      <div class="tab-panel" id="panel-bottom10">
        <div class="table-wrap">
          <div class="table-header-bar">
            <span class="table-title">üìâ Top 10 ‚Äî Menos frecuentes</span>
            <button class="btn-download" onclick="downloadCSV('bottom10')">‚¨á Descargar CSV</button>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead><tr><th>#</th><th>Nombre</th><th>Cantidad</th><th>Primera vez</th><th>√öltima vez</th></tr></thead>
              <tbody id="bottom10Body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab: 5 usos o menos -->
      <div class="tab-panel" id="panel-low5">
        <div class="table-wrap">
          <div class="table-header-bar">
            <div>
              <span class="table-title">‚ö†Ô∏è Consignatarios con 5 usos o menos</span>
              <span class="table-count" id="low5Count"></span>
            </div>
            <button class="btn-download" onclick="downloadCSV('low5')">‚¨á Descargar CSV</button>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead><tr><th>#</th><th>Nombre</th><th>Cantidad</th><th>Primera vez</th><th>√öltima vez</th></tr></thead>
              <tbody id="low5Body"></tbody>
            </table>
          </div>
          <div class="pagination" id="low5Pagination"></div>
        </div>
      </div>

      <!-- Tab: Charts -->
      <div class="tab-panel" id="panel-charts">
        <div class="chart-grid">
          <div class="chart-card">
            <div class="chart-card-title"><span>üèÜ</span> Top 10 m√°s frecuentes</div>
            <div class="bar-chart" id="chartTop10"></div>
          </div>
          <div class="chart-card">
            <div class="chart-card-title"><span>üìâ</span> Top 10 menos frecuentes</div>
            <div class="bar-chart" id="chartBottom10"></div>
          </div>
        </div>
        <div class="chart-grid">
          <div class="chart-card" style="grid-column: 1 / -1;">
            <div class="chart-card-title"><span>üìÖ</span> Registros por mes</div>
            <div class="monthly-bars" id="monthlyChart"></div>
          </div>
        </div>
        <div class="chart-grid">
          <div class="chart-card" style="grid-column: 1 / -1;">
            <div class="chart-card-title"><span>üìä</span> Distribuci√≥n de frecuencia</div>
            <div class="freq-grid" id="freqDist"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// ===================== STATE =====================
let rawData = []; // {name, date, dateObj, monthKey}
let aggregated = []; // {name, count, firstDate, lastDate}
let filteredData = [];
let sortCol = 'count';
let sortDir = 'desc';
let currentPage = 1;
let low5Page = 1;
const PAGE_SIZE = 25;
const MONTHS_ES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const MONTHS_FULL = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

// ===================== UPLOAD =====================
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    parseCSV(text, file.name, file.size);
  };
  reader.readAsText(file, 'UTF-8');
}

// ===================== PARSE =====================
function parseCSV(text, fileName, fileSize) {
  rawData = [];
  let currentDate = null;
  let currentDateObj = null;
  let tramaCount = 0;
  const tramasDates = [];

  const lines = text.split(/\r?\n/);

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) continue;

    // Check if it's a TRAMA header
    const tramaMatch = trimmed.match(/^TRAMA\s+(\d{2})\/(\d{2})\/(\d{4})/);
    if (tramaMatch) {
      const day = parseInt(tramaMatch[1]);
      const month = parseInt(tramaMatch[2]);
      const year = parseInt(tramaMatch[3]);
      currentDate = `${tramaMatch[1]}/${tramaMatch[2]}/${tramaMatch[3]}`;
      currentDateObj = new Date(year, month - 1, day);
      tramaCount++;
      tramasDates.push(currentDateObj);
      continue;
    }

    // Parse data row - split by comma but respect quotes
    const cols = parseCSVLine(trimmed);
    if (cols.length >= 3) {
      const name = (cols[2] || '').trim();
      if (name && name.length > 1 && !/^\d+$/.test(name)) {
        const monthKey = currentDateObj
          ? `${currentDateObj.getFullYear()}-${String(currentDateObj.getMonth()+1).padStart(2,'0')}`
          : 'sin-fecha';
        rawData.push({
          name: normalizeName(name),
          date: currentDate,
          dateObj: currentDateObj,
          monthKey
        });
      }
    }
  }

  // Aggregate
  const map = {};
  for (const r of rawData) {
    if (!map[r.name]) {
      map[r.name] = { name: r.name, count: 0, firstDate: r.dateObj, lastDate: r.dateObj, months: new Set() };
    }
    map[r.name].count++;
    map[r.name].months.add(r.monthKey);
    if (r.dateObj && (!map[r.name].firstDate || r.dateObj < map[r.name].firstDate)) map[r.name].firstDate = r.dateObj;
    if (r.dateObj && (!map[r.name].lastDate || r.dateObj > map[r.name].lastDate)) map[r.name].lastDate = r.dateObj;
  }

  aggregated = Object.values(map);

  // Populate month filter
  const monthKeys = [...new Set(rawData.map(r => r.monthKey))].sort();
  const monthFilter = document.getElementById('monthFilter');
  monthFilter.innerHTML = '<option value="all">Todos los meses</option>';
  for (const mk of monthKeys) {
    if (mk === 'sin-fecha') continue;
    const [y, m] = mk.split('-');
    monthFilter.innerHTML += `<option value="${mk}">${MONTHS_FULL[parseInt(m)-1]} ${y}</option>`;
  }

  // Show UI
  uploadZone.style.display = 'none';
  document.getElementById('fileBar').classList.add('visible');
  document.getElementById('fileName').textContent = fileName;
  document.getElementById('fileMeta').textContent =
    `${(fileSize/1024).toFixed(1)} KB ¬∑ ${rawData.length} registros ¬∑ ${tramaCount} tramas`;
  document.getElementById('headerBadge').textContent = `${rawData.length} REGISTROS`;
  document.getElementById('dashboard').classList.add('visible');

  // KPIs
  document.getElementById('kpiTotal').textContent = rawData.length.toLocaleString();
  document.getElementById('kpiUnique').textContent = aggregated.length.toLocaleString();
  const recurrent = aggregated.filter(a => a.count > 1).length;
  document.getElementById('kpiRecurrent').textContent = recurrent.toLocaleString();
  const avg = aggregated.length ? (rawData.length / aggregated.length).toFixed(1) : 0;
  document.getElementById('kpiAvg').textContent = avg;
  document.getElementById('kpiTramas').textContent = tramaCount;
  if (tramasDates.length) {
    const minD = new Date(Math.min(...tramasDates.map(d=>d.getTime())));
    const maxD = new Date(Math.max(...tramasDates.map(d=>d.getTime())));
    document.getElementById('kpiTramaRange').textContent =
      `${formatDate(minD)} ‚Üí ${formatDate(maxD)}`;
  }

  applyFilters();
  renderCharts();
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') { inQuotes = !inQuotes; }
    else if (ch === ',' && !inQuotes) { result.push(current); current = ''; }
    else { current += ch; }
  }
  result.push(current);
  return result;
}

function normalizeName(name) {
  return name.replace(/\s+/g, ' ').trim();
}

function formatDate(d) {
  if (!d) return '‚Äî';
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}

// ===================== FILTERS =====================
document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; applyFilters(); });
document.getElementById('monthFilter').addEventListener('change', () => { currentPage = 1; applyFilters(); });
document.getElementById('minFilter').addEventListener('change', () => { currentPage = 1; applyFilters(); });

function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  const month = document.getElementById('monthFilter').value;
  const minUsos = parseInt(document.getElementById('minFilter').value);

  let data;

  if (month !== 'all') {
    // Re-aggregate for this month
    const monthRecords = rawData.filter(r => r.monthKey === month);
    const map = {};
    for (const r of monthRecords) {
      if (!map[r.name]) {
        map[r.name] = { name: r.name, count: 0, firstDate: r.dateObj, lastDate: r.dateObj };
      }
      map[r.name].count++;
      if (r.dateObj && (!map[r.name].firstDate || r.dateObj < map[r.name].firstDate)) map[r.name].firstDate = r.dateObj;
      if (r.dateObj && (!map[r.name].lastDate || r.dateObj > map[r.name].lastDate)) map[r.name].lastDate = r.dateObj;
    }
    data = Object.values(map);
  } else {
    data = [...aggregated];
  }

  if (search) {
    data = data.filter(d => d.name.toLowerCase().includes(search));
  }

  if (minUsos > 0) {
    if (minUsos === 1) {
      data = data.filter(d => d.count === 1);
    } else {
      data = data.filter(d => d.count >= minUsos);
    }
  }

  filteredData = sortData(data);
  renderMainTable();
  renderTop10();
  renderBottom10();
  renderLow5();
}

function sortData(data) {
  const d = [...data];
  d.sort((a, b) => {
    let va, vb;
    if (sortCol === 'name') { va = a.name.toLowerCase(); vb = b.name.toLowerCase(); }
    else if (sortCol === 'count') { va = a.count; vb = b.count; }
    else if (sortCol === 'first') { va = a.firstDate?.getTime() || 0; vb = b.firstDate?.getTime() || 0; }
    else if (sortCol === 'last') { va = a.lastDate?.getTime() || 0; vb = b.lastDate?.getTime() || 0; }
    else { va = 0; vb = 0; }

    if (va < vb) return sortDir === 'asc' ? -1 : 1;
    if (va > vb) return sortDir === 'asc' ? 1 : -1;
    return 0;
  });
  return d;
}

// ===================== TABLE SORTING =====================
document.querySelectorAll('thead th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (col === 'rank') return;
    if (sortCol === col) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
    else { sortCol = col; sortDir = col === 'name' ? 'asc' : 'desc'; }

    // Update UI
    document.querySelectorAll('thead th').forEach(t => {
      t.classList.remove('sorted');
      t.querySelector('.sort-arrow').textContent = '‚áÖ';
    });
    th.classList.add('sorted');
    th.querySelector('.sort-arrow').textContent = sortDir === 'asc' ? '‚ñ≤' : '‚ñº';

    currentPage = 1;
    applyFilters();
  });
});

// ===================== RENDER TABLES =====================
function renderMainTable() {
  const tbody = document.getElementById('mainTableBody');
  const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);
  if (currentPage > totalPages) currentPage = totalPages || 1;

  const start = (currentPage - 1) * PAGE_SIZE;
  const page = filteredData.slice(start, start + PAGE_SIZE);

  document.getElementById('tableCount').textContent = ` ‚Äî ${filteredData.length} resultados`;

  tbody.innerHTML = page.map((d, i) => `
    <tr>
      <td class="td-rank">${start + i + 1}</td>
      <td class="td-name">${esc(d.name)}</td>
      <td class="td-count"><span class="count-badge ${d.count >= 5 ? 'count-high' : d.count >= 2 ? 'count-mid' : 'count-low'}">${d.count}</span></td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.firstDate)}</td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.lastDate)}</td>
    </tr>
  `).join('');

  renderPagination('mainPagination', currentPage, totalPages, p => { currentPage = p; renderMainTable(); });
}

function renderTop10() {
  const sorted = [...filteredData].sort((a, b) => b.count - a.count).slice(0, 10);
  document.getElementById('top10Body').innerHTML = sorted.map((d, i) => `
    <tr>
      <td class="td-rank">${i + 1}</td>
      <td class="td-name">${esc(d.name)}</td>
      <td class="td-count"><span class="count-badge count-high">${d.count}</span></td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.firstDate)}</td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.lastDate)}</td>
    </tr>
  `).join('');
}

function renderBottom10() {
  const sorted = [...filteredData].sort((a, b) => a.count - b.count).slice(0, 10);
  document.getElementById('bottom10Body').innerHTML = sorted.map((d, i) => `
    <tr>
      <td class="td-rank">${i + 1}</td>
      <td class="td-name">${esc(d.name)}</td>
      <td class="td-count"><span class="count-badge count-low">${d.count}</span></td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.firstDate)}</td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.lastDate)}</td>
    </tr>
  `).join('');
}

function renderLow5() {
  const low5Data = [...filteredData].filter(d => d.count <= 5).sort((a, b) => a.count - b.count);
  const totalPages = Math.ceil(low5Data.length / PAGE_SIZE);
  if (low5Page > totalPages) low5Page = totalPages || 1;

  document.getElementById('low5Count').textContent = ` ‚Äî ${low5Data.length} consignatarios`;

  const start = (low5Page - 1) * PAGE_SIZE;
  const page = low5Data.slice(start, start + PAGE_SIZE);

  document.getElementById('low5Body').innerHTML = page.map((d, i) => `
    <tr>
      <td class="td-rank">${start + i + 1}</td>
      <td class="td-name">${esc(d.name)}</td>
      <td class="td-count"><span class="count-badge ${d.count >= 2 ? 'count-mid' : 'count-low'}">${d.count}</span></td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.firstDate)}</td>
      <td style="font-size:13px;color:var(--text-muted)">${formatDate(d.lastDate)}</td>
    </tr>
  `).join('');

  renderPagination('low5Pagination', low5Page, totalPages, p => { low5Page = p; renderLow5(); });
}

// ===================== PAGINATION =====================
function renderPagination(containerId, page, totalPages, callback) {
  const container = document.getElementById(containerId);
  if (totalPages <= 1) { container.innerHTML = ''; return; }

  let html = `<div class="pagination-info">P√°gina ${page} de ${totalPages}</div><div class="pagination-btns">`;

  html += `<button class="pg-btn ${page === 1 ? 'disabled' : ''}" onclick="event.stopPropagation()" data-page="${page-1}">‚Äπ</button>`;

  const range = getPageRange(page, totalPages);
  for (const p of range) {
    if (p === '...') {
      html += `<button class="pg-btn disabled">‚Ä¶</button>`;
    } else {
      html += `<button class="pg-btn ${p === page ? 'active' : ''}" data-page="${p}">${p}</button>`;
    }
  }

  html += `<button class="pg-btn ${page === totalPages ? 'disabled' : ''}" data-page="${page+1}">‚Ä∫</button>`;
  html += `</div>`;

  container.innerHTML = html;

  container.querySelectorAll('.pg-btn:not(.disabled)').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = parseInt(btn.dataset.page);
      if (p >= 1 && p <= totalPages) callback(p);
    });
  });
}

function getPageRange(current, total) {
  if (total <= 7) return Array.from({length: total}, (_, i) => i + 1);
  const pages = [];
  if (current <= 4) { pages.push(1,2,3,4,5,'...',total); }
  else if (current >= total - 3) { pages.push(1,'...',total-4,total-3,total-2,total-1,total); }
  else { pages.push(1,'...',current-1,current,current+1,'...',total); }
  return pages;
}

// ===================== CHARTS =====================
function renderCharts() {
  // Top 10 bar chart
  const top10 = [...aggregated].sort((a, b) => b.count - a.count).slice(0, 10);
  const maxCount = top10[0]?.count || 1;

  document.getElementById('chartTop10').innerHTML = top10.map(d => {
    const pct = (d.count / maxCount * 100).toFixed(1);
    const shortName = d.name.length > 22 ? d.name.substring(0, 22) + '‚Ä¶' : d.name;
    return `
      <div class="bar-row">
        <div class="bar-label" title="${esc(d.name)}">${esc(shortName)}</div>
        <div class="bar-track">
          <div class="bar-fill bar-fill-top" style="width: ${pct}%">
            ${d.count > 2 ? `<span class="bar-value">${d.count}</span>` : ''}
          </div>
        </div>
        ${d.count <= 2 ? `<span class="bar-value-outside">${d.count}</span>` : ''}
      </div>
    `;
  }).join('');

  // Bottom 10 bar chart
  const bottom10 = [...aggregated].sort((a, b) => a.count - b.count).slice(0, 10);
  const maxBot = bottom10[bottom10.length - 1]?.count || 1;

  document.getElementById('chartBottom10').innerHTML = bottom10.map(d => {
    const pct = Math.max((d.count / maxBot * 100), 15).toFixed(1);
    const shortName = d.name.length > 22 ? d.name.substring(0, 22) + '‚Ä¶' : d.name;
    return `
      <div class="bar-row">
        <div class="bar-label" title="${esc(d.name)}">${esc(shortName)}</div>
        <div class="bar-track">
          <div class="bar-fill bar-fill-bottom" style="width: ${pct}%">
            ${d.count > 1 ? `<span class="bar-value">${d.count}</span>` : ''}
          </div>
        </div>
        ${d.count <= 1 ? `<span class="bar-value-outside">${d.count}</span>` : ''}
      </div>
    `;
  }).join('');

  // Monthly chart
  const monthMap = {};
  for (const r of rawData) {
    monthMap[r.monthKey] = (monthMap[r.monthKey] || 0) + 1;
  }
  const monthKeys = Object.keys(monthMap).filter(k => k !== 'sin-fecha').sort();
  const maxMonth = Math.max(...Object.values(monthMap), 1);

  document.getElementById('monthlyChart').innerHTML = monthKeys.map(mk => {
    const [y, m] = mk.split('-');
    const val = monthMap[mk];
    const pct = (val / maxMonth * 100).toFixed(1);
    return `
      <div class="month-col">
        <div class="month-bar-wrap">
          <div class="month-bar" style="height: ${pct}%" title="${MONTHS_FULL[parseInt(m)-1]} ${y}: ${val} registros">
            <div class="month-bar-val">${val}</div>
          </div>
        </div>
        <div class="month-label">${MONTHS_ES[parseInt(m)-1]}<br>${y}</div>
      </div>
    `;
  }).join('');

  // Frequency distribution
  const freqMap = {};
  for (const a of aggregated) {
    const bucket = a.count;
    freqMap[bucket] = (freqMap[bucket] || 0) + 1;
  }
  const freqKeys = Object.keys(freqMap).map(Number).sort((a, b) => a - b);

  document.getElementById('freqDist').innerHTML = freqKeys.map(k => `
    <div class="freq-cell">
      <div class="freq-num">${freqMap[k]}</div>
      <div class="freq-label">${k} ${k === 1 ? 'uso' : 'usos'}</div>
    </div>
  `).join('');
}

// ===================== TABS =====================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
  });
});

// ===================== DOWNLOAD =====================
function downloadCSV(type) {
  let data;
  let filename;

  if (type === 'full') {
    data = filteredData;
    filename = 'consignatarios_completo.csv';
  } else if (type === 'top10') {
    data = [...filteredData].sort((a, b) => b.count - a.count).slice(0, 10);
    filename = 'consignatarios_top10.csv';
  } else if (type === 'bottom10') {
    data = [...filteredData].sort((a, b) => a.count - b.count).slice(0, 10);
    filename = 'consignatarios_bottom10.csv';
  } else if (type === 'low5') {
    data = filteredData.filter(d => d.count <= 5).sort((a, b) => a.count - b.count);
    filename = 'consignatarios_5_o_menos.csv';
  }

  const bom = '\uFEFF';
  let csv = bom + 'Nombre,Cantidad,Primera Vez,Ultima Vez\n';
  for (const d of data) {
    csv += `"${d.name}",${d.count},${formatDate(d.firstDate)},${formatDate(d.lastDate)}\n`;
  }

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// ===================== RESET =====================
function resetApp() {
  rawData = [];
  aggregated = [];
  filteredData = [];
  currentPage = 1;
  low5Page = 1;
  uploadZone.style.display = '';
  document.getElementById('fileBar').classList.remove('visible');
  document.getElementById('dashboard').classList.remove('visible');
  document.getElementById('headerBadge').textContent = 'SIN DATOS';
  document.getElementById('searchInput').value = '';
  fileInput.value = '';
}

// ===================== UTIL =====================
function esc(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}
</script>
</body>
</html>
